name: fix-controller-test

services:
  fix-profiler-ui:
    profiles: [ "profiler-ui" ]
    build:
      context: ../..
      dockerfile: test/integration/Dockerfile.profiler
    image: ${FIX_PROFILER_IMAGE:-fix-controller-profiler-ui:alpine}
    environment:
      PROFILE_ROOT: /profiles
      PROFILE_UI_HOST: 0.0.0.0
      PROFILE_UI_PORT: 8080
      AUTO_FLAMEGRAPH: ${FIX_AUTO_FLAMEGRAPH:-1}
      FORCE_FLAMEGRAPH_REBUILD: ${FIX_FORCE_FLAMEGRAPH_REBUILD:-0}
    ports:
      - "${FIX_PROFILE_UI_PORT:-8080}:8080"
    user: "${FIX_UID:-1000}:${FIX_GID:-1000}"
    volumes:
      - ./profiles:/profiles

  fix-builder:
    profiles: [ "build-bin" ]
    build:
      context: ../..
      dockerfile: test/integration/Dockerfile.builder
      args:
        BASE_IMAGE: ${FIX_BASE_IMAGE:-ubuntu:24.04}
        COMPILER_FAMILY: ${FIX_COMPILER_FAMILY:-g++}
        COMPILER_VERSION: ${FIX_COMPILER_VERSION:-}
    image: ${FIX_BUILDER_IMAGE:-fix-controller-builder:ubuntu-24.04-gxx-latest}
    working_dir: /workspace
    environment:
      FIX_COMPILER_FAMILY: ${FIX_COMPILER_FAMILY:-g++}
      FIX_COMPILER_VERSION: ${FIX_COMPILER_VERSION:-}
    command: >
      bash -lc "set -euo pipefail &&
      cc_bin=gcc &&
      cxx_bin=g++ &&
      if [ \"$${FIX_COMPILER_FAMILY}\" = \"clang\" ]; then cc_bin=clang; cxx_bin=clang++; fi &&
      if [ -n \"$${FIX_COMPILER_VERSION}\" ]; then
        if command -v \"$${cc_bin}-$${FIX_COMPILER_VERSION}\" >/dev/null 2>&1; then cc_bin=\"$${cc_bin}-$${FIX_COMPILER_VERSION}\"; fi &&
        if command -v \"$${cxx_bin}-$${FIX_COMPILER_VERSION}\" >/dev/null 2>&1; then cxx_bin=\"$${cxx_bin}-$${FIX_COMPILER_VERSION}\"; fi;
      fi &&
      rm -rf /tmp/build &&
      cmake -S /workspace -B /tmp/build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=\"$${cc_bin}\" -DCMAKE_CXX_COMPILER=\"$${cxx_bin}\" &&
      cmake --build /tmp/build --target fix_controller_demo --parallel 3 &&
      cp /tmp/build/Release/bin/fix_controller_demo /out/fix_controller_demo &&
      chmod +x /out/fix_controller_demo"
    volumes:
      - ../..:/workspace:ro
      - fix-controller-bin:/out

  fix-exchange-1:
    build:
      context: ../..
      dockerfile: test/integration/Dockerfile.runtime
      args:
        BASE_IMAGE: ${FIX_BASE_IMAGE:-ubuntu:24.04}
    image: ${FIX_RUNTIME_IMAGE:-fix-controller-runtime:ubuntu-24.04-gxx-latest}
    environment:
      FIX_ROLE: exchange
      FIX_PORT: 5001
      FIX_BEGIN_STRING: ${FIX_EXCHANGE_1_BEGIN_STRING:-FIX.4.4}
      FIX_SCENARIO: ${FIX_SCENARIO:-handshake}
      FIX_CONVERSATION_MESSAGES: ${FIX_CONVERSATION_MESSAGES:-100}
      FIX_PERF_PAYLOAD_SIZE: ${FIX_PERF_PAYLOAD_SIZE:-512}
      FIX_RUNTIME_SECONDS: ${FIX_RUNTIME_SECONDS:-30}
      LLVM_PROFILE_FILE: ${LLVM_PROFILE_FILE:-}
    ports:
      - "${FIX_EXCHANGE_1_HOST_PORT:-15001}:5001"
    volumes:
      - fix-controller-bin:/app:ro
      - ../..:/workspace:ro
      - ${FIX_PROFILE_OUTPUT_HOST_DIR:-/tmp/fix-controller-profiles}:/profiles
    networks:
      - fixnet

  fix-exchange-2:
    image: ${FIX_RUNTIME_IMAGE:-fix-controller-runtime:ubuntu-24.04-gxx-latest}
    depends_on:
      - fix-exchange-1
    environment:
      FIX_ROLE: exchange
      FIX_PORT: 5001
      FIX_BEGIN_STRING: ${FIX_EXCHANGE_2_BEGIN_STRING:-FIX.4.4}
      FIX_SCENARIO: ${FIX_SCENARIO:-handshake}
      FIX_CONVERSATION_MESSAGES: ${FIX_CONVERSATION_MESSAGES:-100}
      FIX_PERF_PAYLOAD_SIZE: ${FIX_PERF_PAYLOAD_SIZE:-512}
      FIX_RUNTIME_SECONDS: ${FIX_RUNTIME_SECONDS:-30}
      LLVM_PROFILE_FILE: ${LLVM_PROFILE_FILE:-}
    ports:
      - "${FIX_EXCHANGE_2_HOST_PORT:-15002}:5001"
    volumes:
      - fix-controller-bin:/app:ro
      - ../..:/workspace:ro
      - ${FIX_PROFILE_OUTPUT_HOST_DIR:-/tmp/fix-controller-profiles}:/profiles
    networks:
      - fixnet

  fix-client-1:
    profiles: [ "single-client" ]
    image: ${FIX_RUNTIME_IMAGE:-fix-controller-runtime:ubuntu-24.04-gxx-latest}
    depends_on:
      - fix-exchange-1
      - fix-exchange-2
    environment:
      FIX_ROLE: client
      FIX_HOSTS: fix-exchange-1
      FIX_PORTS: 5001
      FIX_PORT: 5001
      FIX_BEGIN_STRING: ${FIX_CLIENT_1_BEGIN_STRING:-FIX.4.4}
      FIX_SCENARIO: ${FIX_SCENARIO:-handshake}
      FIX_CONVERSATION_MESSAGES: ${FIX_CONVERSATION_MESSAGES:-100}
      FIX_PERF_PAYLOAD_SIZE: ${FIX_PERF_PAYLOAD_SIZE:-512}
      FIX_RUNTIME_SECONDS: ${FIX_RUNTIME_SECONDS:-30}
      FIX_MESSAGE_FILE: ${FIX_MESSAGE_FILE:-}
      FIX_REALISTIC_MESSAGES_DIR: ${FIX_REALISTIC_MESSAGES_DIR:-/workspace/data/samples/realistic}
      LLVM_PROFILE_FILE: ${LLVM_PROFILE_FILE:-}
    volumes:
      - fix-controller-bin:/app:ro
      - ../..:/workspace:ro
      - ${FIX_PROFILE_OUTPUT_HOST_DIR:-/tmp/fix-controller-profiles}:/profiles
    networks:
      - fixnet

  fix-client-multi:
    profiles: [ "multi-exchange" ]
    image: ${FIX_RUNTIME_IMAGE:-fix-controller-runtime:ubuntu-24.04-gxx-latest}
    depends_on:
      - fix-exchange-1
      - fix-exchange-2
    environment:
      FIX_ROLE: client
      FIX_HOSTS: fix-exchange-1,fix-exchange-2
      FIX_PORTS: 5001,5001
      FIX_PORT: 5001
      FIX_BEGIN_STRING: ${FIX_CLIENT_MULTI_BEGIN_STRING:-FIX.4.4}
      FIX_SCENARIO: ${FIX_SCENARIO:-handshake}
      FIX_CONVERSATION_MESSAGES: ${FIX_CONVERSATION_MESSAGES:-100}
      FIX_PERF_PAYLOAD_SIZE: ${FIX_PERF_PAYLOAD_SIZE:-512}
      FIX_RUNTIME_SECONDS: ${FIX_RUNTIME_SECONDS:-30}
      FIX_MESSAGE_FILE: ${FIX_MESSAGE_FILE:-}
      FIX_REALISTIC_MESSAGES_DIR: ${FIX_REALISTIC_MESSAGES_DIR:-/workspace/data/samples/realistic}
      LLVM_PROFILE_FILE: ${LLVM_PROFILE_FILE:-}
    volumes:
      - fix-controller-bin:/app:ro
      - ../..:/workspace:ro
      - ${FIX_PROFILE_OUTPUT_HOST_DIR:-/tmp/fix-controller-profiles}:/profiles
    networks:
      - fixnet

  fix-client-2:
    profiles: [ "multi-client" ]
    image: ${FIX_RUNTIME_IMAGE:-fix-controller-runtime:ubuntu-24.04-gxx-latest}
    depends_on:
      - fix-exchange-1
      - fix-exchange-2
    environment:
      FIX_ROLE: client
      FIX_HOSTS: fix-exchange-2
      FIX_PORTS: 5001
      FIX_PORT: 5001
      FIX_BEGIN_STRING: ${FIX_CLIENT_2_BEGIN_STRING:-FIX.4.4}
      FIX_SCENARIO: ${FIX_SCENARIO:-handshake}
      FIX_CONVERSATION_MESSAGES: ${FIX_CONVERSATION_MESSAGES:-100}
      FIX_PERF_PAYLOAD_SIZE: ${FIX_PERF_PAYLOAD_SIZE:-512}
      FIX_RUNTIME_SECONDS: ${FIX_RUNTIME_SECONDS:-30}
      FIX_MESSAGE_FILE: ${FIX_MESSAGE_FILE:-}
      FIX_REALISTIC_MESSAGES_DIR: ${FIX_REALISTIC_MESSAGES_DIR:-/workspace/data/samples/realistic}
      LLVM_PROFILE_FILE: ${LLVM_PROFILE_FILE:-}
    volumes:
      - fix-controller-bin:/app:ro
      - ../..:/workspace:ro
      - ${FIX_PROFILE_OUTPUT_HOST_DIR:-/tmp/fix-controller-profiles}:/profiles
    networks:
      - fixnet

  fix-client-mesh-1:
    profiles: [ "multi-mesh" ]
    image: ${FIX_RUNTIME_IMAGE:-fix-controller-runtime:ubuntu-24.04-gxx-latest}
    depends_on:
      - fix-exchange-1
      - fix-exchange-2
    environment:
      FIX_ROLE: client
      FIX_HOSTS: fix-exchange-1,fix-exchange-2
      FIX_PORTS: 5001,5001
      FIX_PORT: 5001
      FIX_BEGIN_STRING: ${FIX_CLIENT_MESH_1_BEGIN_STRING:-FIX.4.4}
      FIX_SCENARIO: ${FIX_SCENARIO:-conversation}
      FIX_CONVERSATION_MESSAGES: ${FIX_CONVERSATION_MESSAGES:-100}
      FIX_PERF_PAYLOAD_SIZE: ${FIX_PERF_PAYLOAD_SIZE:-512}
      FIX_RUNTIME_SECONDS: ${FIX_RUNTIME_SECONDS:-30}
      FIX_MESSAGE_FILE: ${FIX_MESSAGE_FILE:-}
      FIX_REALISTIC_MESSAGES_DIR: ${FIX_REALISTIC_MESSAGES_DIR:-/workspace/data/samples/realistic}
      LLVM_PROFILE_FILE: ${LLVM_PROFILE_FILE:-}
    volumes:
      - fix-controller-bin:/app:ro
      - ../..:/workspace:ro
      - ${FIX_PROFILE_OUTPUT_HOST_DIR:-/tmp/fix-controller-profiles}:/profiles
    networks:
      - fixnet

  fix-client-mesh-2:
    profiles: [ "multi-mesh" ]
    image: ${FIX_RUNTIME_IMAGE:-fix-controller-runtime:ubuntu-24.04-gxx-latest}
    depends_on:
      - fix-exchange-1
      - fix-exchange-2
    environment:
      FIX_ROLE: client
      FIX_HOSTS: fix-exchange-1,fix-exchange-2
      FIX_PORTS: 5001,5001
      FIX_PORT: 5001
      FIX_BEGIN_STRING: ${FIX_CLIENT_MESH_2_BEGIN_STRING:-FIX.4.4}
      FIX_SCENARIO: ${FIX_SCENARIO:-conversation}
      FIX_CONVERSATION_MESSAGES: ${FIX_CONVERSATION_MESSAGES:-100}
      FIX_PERF_PAYLOAD_SIZE: ${FIX_PERF_PAYLOAD_SIZE:-512}
      FIX_RUNTIME_SECONDS: ${FIX_RUNTIME_SECONDS:-30}
      FIX_MESSAGE_FILE: ${FIX_MESSAGE_FILE:-}
      FIX_REALISTIC_MESSAGES_DIR: ${FIX_REALISTIC_MESSAGES_DIR:-/workspace/data/samples/realistic}
      LLVM_PROFILE_FILE: ${LLVM_PROFILE_FILE:-}
    volumes:
      - fix-controller-bin:/app:ro
      - ../..:/workspace:ro
      - ${FIX_PROFILE_OUTPUT_HOST_DIR:-/tmp/fix-controller-profiles}:/profiles
    networks:
      - fixnet

networks:
  fixnet:
    driver: bridge

volumes:
  fix-controller-bin:
